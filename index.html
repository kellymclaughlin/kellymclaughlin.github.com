
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>kelly-mclaughlin.com</title>
  <meta name="author" content="Kelly McLaughlin">

  
  <meta name="description" content="Several months back someone reported an
issue when
attempting to use
druuid as a dependency
in an Elixir project. At the time I was not able to look &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kelly-mclaughlin.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/KellyMcLaughlin" rel="alternate" title="kelly-mclaughlin.com" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">kelly-mclaughlin.com</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/KellyMcLaughlin" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kelly-mclaughlin.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/02/platform-specific-build-options-with-rebar/">Platform-Specific Build Options With Rebar</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-02T10:48:46-07:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2014</time>
        
           | <a href="/blog/2014/12/02/platform-specific-build-options-with-rebar/#disqus_thread"
             data-disqus-identifier="http://kelly-mclaughlin.com/blog/2014/12/02/platform-specific-build-options-with-rebar/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Several months back someone reported an
<a href="https://github.com/kellymclaughlin/druuid/issues/3">issue</a> when
attempting to use
<a href="https://github.com/kellymclaughlin/druuid"><code>druuid</code></a> as a dependency
in an Elixir project.  At the time I was not able to look into it, but
recently I circled back to dig deeper into the problem (described in
more detail <a href="https://github.com/elixir-lang/elixir/issues/2189">here</a>)
and in the process I stumbled across some useful rebar configuration
options for projects that have platform-specific build requirements. I
use rebar quite a bit, but I was not aware that these options
existed so I wrote this in case other rebar users find themselves in a
similar state of ignorance.</p>

<p><code>Druuid</code> needs to differentiate between BSD and non-BSD systems during
the <code>compile</code> and <code>clean</code> operations. This is due to a conflict with
the OS-provided UUID library on BSD systems.  The original method used
to achieve this was rebar&rsquo;s dynamic configuration capability. A
rebar.config.script file was used to check the system architecture
information using <code>rebar_utils:is_arch/1</code> and modify the rebar
configuration appropriately based on the results (<a href="https://github.com/kellymclaughlin/druuid/pull/2">relevant github issue</a>). <a href="https://github.com/kellymclaughlin/druuid/blob/0.2/rebar.config.script">Here</a>
is the full listing of the <code>rebar.config.script</code> file for reference.</p>

<p>This solution certainly works, but it would be great if there was a
way to use standard rebar configuration options to solve the problem
and even better if anyone who wants to use the library, be it in
an Erlang project or an Elixir project, could easily do so.</p>

<p>Fortunately such configuration capabilities already exist in
rebar. <code>Druuid</code> uses four rebar configuration directives to tailor the
build environment and steps based on the platform.  These are as
follows: <code>port_specs</code>, <code>port_env</code>, <code>pre_hooks</code>, <code>post_hooks</code>. Each
option is specified in the <code>rebar.config</code> file as a pair where the
first element is the option name and the second element is a list of
tuples.</p>

<p>For example, here is what a <code>port_env</code> entry might look like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{port_env, [{"CFLAGS", "$CFLAGS -fPIC"},
</span><span class='line'>            {"DRV_CFLAGS", "$DRV_CFLAGS -Werror -I c_src/uuid-1.6.2"},
</span><span class='line'>            {"DRV_LDFLAGS", "$DRV_LDFLAGS c_src/uuid-1.6.2/.libs/libuuid.a"}
</span><span class='line'>]}.</span></code></pre></td></tr></table></div></figure>


<p>It turns out that the value tuples can be a pair as shown in the above
example <strong>or</strong> they can be triples where the first element is a
regular expression that is applied as a filter to the platform
information. Let&rsquo;s see an example of that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{port_env, [{"CFLAGS", "$CFLAGS -fPIC"},
</span><span class='line'>            {"(bsd)", "DRV_CFLAGS", "$DRV_CFLAGS -Werror"},
</span><span class='line'>            {"(bsd)", "DRV_LDFLAGS", "$DRV_LDFLAGS"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_CFLAGS", "$DRV_CFLAGS -Werror -I c_src/uuid-1.6.2"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_LDFLAGS", "$DRV_LDFLAGS c_src/uuid-1.6.2/.libs/libuuid.a"}
</span><span class='line'>]}.</span></code></pre></td></tr></table></div></figure>


<p>The <code>CFLAGS</code> value is applied to all platforms, but <code>DRV_CFLAGS</code> and
<code>DRV_LDFLAGS</code> are selected based on whether the platform information
does or does not contain the string <em>bsd</em>. This is very handy and can
also be used for all of the other configuration options used by
<code>druuid</code>. Let&rsquo;s see the final version of the <code>rebar.config</code> file that
translates all of the behavior previously contained in the
<code>rebar.config.script</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{port_specs, [{"priv/druuid.so", ["c_src/*.c"]}]}.
</span><span class='line'>{port_env, [{"CFLAGS", "$CFLAGS -fPIC"},
</span><span class='line'>            {"(bsd)", "DRV_CFLAGS", "$DRV_CFLAGS -Werror"},
</span><span class='line'>            {"(bsd)", "DRV_LDFLAGS", "$DRV_LDFLAGS"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_CFLAGS", "$DRV_CFLAGS -Werror -I c_src/uuid-1.6.2"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_LDFLAGS", "$DRV_LDFLAGS c_src/uuid-1.6.2/.libs/libuuid.a"}
</span><span class='line'>]}.
</span><span class='line'>{pre_hooks, [{"^(?s)((?!bsd).)*$", compile, "c_src/build_deps.sh"}]}.
</span><span class='line'>{post_hooks, [{"^(?s)((?!bsd).)*$", clean, "c_src/build_deps.sh clean"}]}.</span></code></pre></td></tr></table></div></figure>


<p>This is much nicer than resorting to using rebar&rsquo;s dynamic
configuration and as a bonus it works much better with Elixir&rsquo;s build
tool, <a href="http://elixir-lang.org/getting_started/mix_otp/1.html">Mix</a>. If
you want to explore how the regular expressions are treated inside
rebar, look
<a href="https://github.com/rebar/rebar/blob/2.5.1/src/rebar_core.erl#L507">here</a>
for the hooks,
<a href="https://github.com/rebar/rebar/blob/2.5.1/src/rebar_port_compiler.erl#L308">here</a>
for the <code>port_specs</code>, and
<a href="https://github.com/rebar/rebar/blob/2.5.1/src/rebar_port_compiler.erl#L484">here</a>
for the <code>port_env</code> for the port options.</p>

<p>I did not find any mention of these options in the rebar wiki. I did
find some examples of the port options in the output of <code>rebar help
compile</code>, but hopefully this post sheds some further light on their
intended purpose. Also note that the information in this post is based
on the <code>2.5.1</code> tag of rebar. Later tags or the work on
<a href="https://github.com/rebar/rebar3">rebar3</a> may make some of this
information obsolete.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/27/emacs-daemon/">Setting Up the Emacs Daemon on OS X</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-27T00:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2012/07/27/emacs-daemon/#disqus_thread"
             data-disqus-identifier="http://kelly-mclaughlin.com/blog/2012/07/27/emacs-daemon/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>Warning:</em> I only use terminal emacs so I have no idea how well this will work otherwise.</p>

<h2>Install emacs 23 or later.</h2>

<p>Here is what I use to get the very latest emacs goodies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo brew install emacs --cocoa --use-git-head --HEAD</span></code></pre></td></tr></table></div></figure>


<p>Some people have had trouble with the <code>--cocoa</code> flag so you may find
it convenient to omit that if you do not need the Cocoa version. Also
if you do not want the bleeding edge version, then omit the
<code>--use-git-head --HEAD</code> options.</p>

<h2>Create a plist file and move it to ~/Library/LaunchAgents</h2>

<p>Here is what my file looks like:</p>

<div>
  <pre><code class='xml'>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
  &lt;plist version=&quot;1.0&quot;&gt;
    &lt;dict&gt;
      &lt;key&gt;Label&lt;/key&gt;
      &lt;string&gt;gnu.emacs.daemon&lt;/string&gt;
      &lt;key&gt;ProgramArguments&lt;/key&gt;
      &lt;array&gt;
        &lt;string&gt;/usr/local/Cellar/emacs/HEAD/Emacs.app/Contents/MacOS/Emacs&lt;/string&gt;
        &lt;string&gt;--daemon&lt;/string&gt;
      &lt;/array&gt;
      &lt;key&gt;RunAtLoad&lt;/key&gt;
      &lt;true/&gt;
      &lt;key&gt;ServiceDescription&lt;/key&gt;
      &lt;string&gt;Gnu Emacs Daemon&lt;/string&gt;
      &lt;key&gt;UserName&lt;/key&gt;
      &lt;string&gt;kelly&lt;/string&gt;
    &lt;/dict&gt;
  &lt;/plist&gt;</code></pre>
</div>


<p>Update the path the emacs and change the username to your OS X user name.</p>

<h2>Start the daemon</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>launchctl load gnu.emacs.daemon
</span><span class='line'>launchctl start gnu.emacs.daemon</span></code></pre></td></tr></table></div></figure>


<h3>Edit files with emacsclient instead of emacs</h3>

<p>Instead of opening a file with <code>emacs &lt;filename&gt;</code> instead use <code>emacsclient -nw &lt;filename&gt;</code>.</p>

<p>I created a handy alias in my <code>.bashrc</code> file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>alias e="emacsclient -nw"</span></code></pre></td></tr></table></div></figure>


<h3>Stopping the daemon</h3>

<p>From within emacs, use the <code>save-buffers-kill-emacs</code> command.</p>

<p>Outside of emacs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>emacsclient -e '(save-buffers-kill-emacs)'</span></code></pre></td></tr></table></div></figure>


<h3>Why bother?</h3>

<p>Setting up the daemon has a several advantages.</p>

<ol>
<li>Files load much faster.</li>
<li>You can share buffers among different <code>emacsclient</code> instances.</li>
<li>If you exit all the <code>emacsclient</code> instances and come back later,
your buffers are all still open. When you access a buffer the cursor
will be at the exact spot you left off previously.</li>
</ol>


<h3>Downsides</h3>

<p>The server does occasionally crash, but that is probably because I am
using the bleeding edge version. It hasn&rsquo;t caused me to lose anything
thanks to auto-saving and file recovery so go for it.</p>

<h3>References</h3>

<ul>
<li><a href="http://www.emacswiki.org/emacs/EmacsAsDaemon">EmacsWiki</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/21/riak-debug-vm/">Running Riak With a Debug Version of the Erlang VM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-21T00:00:00-07:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2012/01/21/riak-debug-vm/#disqus_thread"
             data-disqus-identifier="http://kelly-mclaughlin.com/blog/2012/01/21/riak-debug-vm/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I describe how the easiest way to run
<a href="http://www.basho.com">Riak</a> with a debug build of the Erlang
VM. While I focus specifically on Riak, this procedure should hold
true for most Erlang projects that are set up for release builds using
rebar.</p>

<p>First, make sure the debug build of Erlang is the first in your
path. If you have not built a debug-enabled Erlang VM, I covered how
to accomplish that in a prior post and you can find it
<a href="http://kelly-mclaughlin.com/2012/01/03/erlang-debug-vm.html">here</a>.</p>

<p>Next navigate to your Riak repository and do a clean and release build
of Riak.</p>

<div>
  <pre><code class='bash'>make clean rel</code></pre>
</div>


<p>Move to the Riak release directory and open the riak script in an editor.</p>

<div>
  <pre><code class='bash'>cd rel/riak
emacs bin/riak</code></pre>
</div>


<p>Look for the line <code>EMU=beam</code>. It should be located somewhere around
line 228 in the section for the <code>console</code> command. Change that line to
<code>EMU=beam.debug</code> and save the file.</p>

<p>Now you are ready to start up Riak. For this example I just start it
with <em>console</em> instead of <em>start</em>.</p>

<div>
  <pre><code class='bash'>./bin/riak console</code></pre>
</div>


<p>You should notice the Erlang banner is slightly different than
normal. Using the normal Erlang VM the banner looks something like
this:</p>

<div>
  <pre><code class='erlang'>Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:64] [kernel-poll:true]</code></pre>
</div>


<p>However using the debug-enabled VM, it should look something like the
following:</p>

<div>
  <pre><code class='erlang'>Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:64] [kernel-poll:true] [type-assertions] [debug-compiled] [lock-checking]</code></pre>
</div>


<p>And that&rsquo;s all there is to it. Once you have the debug-enabled Erlang
VM built, it&rsquo;s very easy to get Riak up and running with it. It may go
without saying, but Riak will run noticeably slower using the
debug-enabled VM so please do not run in this manner in
production. Happy debugging!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/03/erlang-debug-vm/">How to Build a Debug Version of the Erlang VM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-03T00:00:00-07:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2012/01/03/erlang-debug-vm/#disqus_thread"
             data-disqus-identifier="http://kelly-mclaughlin.com/blog/2012/01/03/erlang-debug-vm/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week I needed a debug build of BEAM (the Erlang VM). I decided to
write this blog post detailing how to go about building it because I
found the process to be cumbersome and the documentation detailing how
to do it rather sparse. There is a section in the
<a href="http://www.erlang.org/doc/installation_guide/INSTALL.html#id70822">Erlang documentation</a>
that discusses how to build a debug-enabled Erlang runtime, but I
found the procedures I will discuss in this post to be more
straightforward. Hopefully my experience can help others who may
venture down this path, but if nothing else it will serve as a useful
reminder for myself the next time I need to do it.</p>

<p>Before starting I should note that all of the following steps have
been performed on my MBP running OSX Lion and using Erlang R15B.</p>

<p>To start things off you&rsquo;ll need to have the Erlang source. Grab the latest
version from <a href="http://www.erlang.org/download.html">here</a> if you do not
already have it. You may want to move the source tarball into an
<em>erlang</em> sub-directory somewhere to keep everything organized.</p>

<p>Next let&rsquo;s build normally. We will specify the installation
destination as a local debug-labeled directory using the <code>--prefix</code>
option to the Erlang/OTP <code>configure</code> script, but we will not install until after
taking some extra steps to build debug versions of BEAM. One important
thing to note is that I have disabled <code>HiPE</code> because I found it to
cause build failures when building the debug versions.</p>

<p>The following is a bash script that can be run to accomplish this
first step. To run it, save the script to the local directory where
you have the erlang source tarball, make it executable, and run
it. The script expects an argument that specifies the version of
Erlang to build. <em>e.g.</em> If you saved the script as <code>build_erlang.sh</code>,
you would run the following: <code>build_erlang.sh R15B</code>.</p>

<div>
  <pre><code class='bash'>#! /bin/bash

OTPVERUC:=$(echo $1 || if=- conv=ucase)
OTPVERLC:=$(echo $1 || if=- conv=lcase)
TARBALL=otp_src_$OTPVERUC.tar.gz
LOCAL_DIR=`pwd`

## Build 64-bit OSX
build_64()
{
tar xfz $TARBALL
mv otp_src_$OTPVERUC{,-64}
( cd otp_src_$OTPVERUC-64 \
    &amp;&amp; ./configure --enable-debug --enable-threads --enable-kernel-poll \
    --enable-smp-support --enable-darwin-64bit --enable-lock-checking=no --disable-hipe \
    --prefix=/Users/kelly/erlang/$OTPVERLC-debug-64 \
    &amp;&amp; make )
}

## Build 64-bit version
build_64</code></pre>
</div>


<p>Once the normal build has successfully completed, it&rsquo;s time to do the
debug build. <code>cd</code> to the unpacked erlang source directory
(<em>otp_src_R15B-64</em> if using the script from above). The next step is
to export a three environment variables in your shell. The first is
<code>ERL_TOP</code> which serves as a reference for many of the build files and
scripts. Next is the <code>FLAVOR</code> and the options are either <code>plain</code> or
<code>smp</code>. Finally <code>TYPE</code> should be set to <code>debug</code>.</p>

<pre>
<code>
export ERL_TOP=`pwd`
export FLAVOR=smp
export TYPE=debug
</code>
</pre>


<p>Now type <code>make</code> and hit enter and wait. Once the build is complete,
there should be a <code>beam.debug.smp</code> file in addition to the normal
<code>beam.smp</code> (assuming you set the FLAVOR as smp). To build the other
flavor, just change the value of <code>FLAVOR</code> and run make again.</p>

<p>The final step is to install everything. Do this by typing <code>make
install</code> and once it completes Erlang/OTP will be installed in
<em>R15B-debug-64</em> including debug-enabled builds of BEAM.</p>

<p>Of course a simplified approach would just be to script all of these
steps, so here is the previous build script augmented to also build
both flavors of the debug vm and then install everything.</p>

<div>
  <pre><code class='bash'>#! /bin/bash

OTPVERUC:=$(echo $1 || if=- conv=ucase)
OTPVERLC:=$(echo $1 || if=- conv=lcase)
TARBALL=otp_src_$OTPVERUC.tar.gz
LOCAL_DIR=`pwd`

## Build 64-bit OSX
build_64()
{
tar xfz $TARBALL
mv otp_src_$OTPVERUC{,-64}
( cd otp_src_$OTPVERUC-64 \
    &amp;&amp; ./configure --enable-debug --enable-threads --enable-kernel-poll \
    --enable-smp-support --enable-darwin-64bit --disable-hipe \
    --prefix=$LOCAL_DIR/$OTPVERLC-debug-64 \
    &amp;&amp; make \
    &amp;&amp; make install \
    &amp;&amp; export TYPE=debug; export FLAVOR=plain; make \
    &amp;&amp; FLAVOR=smp; make \
    &amp;&amp; make install )
}

## Build 64-bit version
build_64</code></pre>
</div>


<p>That&rsquo;s all there is to it. In the next post I will cover how configure
<a href="http://www.basho.com">Riak</a> to run using the debug-enabled version of
Erlang. Until then, happy coding.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/07/08/quickcheck-efficacy/">A Quickcheck in Time Saves Nine</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-08T00:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2011/07/08/quickcheck-efficacy/#disqus_thread"
             data-disqus-identifier="http://kelly-mclaughlin.com/blog/2011/07/08/quickcheck-efficacy/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I am going to present some anecdotal evidence on the efficacy
of property-based testing. The specific tool in this case is Quiviq&rsquo;s
<a href="http://www.quviq.com/">Quickcheck</a>, a property-based testing tool for
Erlang. I am not going to spend <em>much</em> time discussing the particulars
of property-based testing, but instead focus on a specific real-world
instance where it saved me and my employer,
<a href="http://www.basho.com/">Basho</a>, time and money.</p>

<h2>The Bare Essentials</h2>

<p>Very briefly, here is enough about how property-based testing with
Quickcheck works to whet your appetite. When doing property-based
testing you specify a set of properties of the code you are testing,
create a model, and then test if the model holds for all (or a large
number) of permutations of those properties.</p>

<p>My coworker Rusty Klophaus published a very good 3-minute podcast on
property-based testing
<a href="http://riak.minutewith.com/pages/20110128">here</a> that you <em>should</em>
listen to now if you have not already.</p>

<p>The full version of Quickcheck requires a license which I am fortunate
enough to be able to use when testing code for
<a href="http://www.basho.com/">Basho</a>. <a href="http://www.quviq.com/contact.html">Contact</a>
Quiviq for more information about that or they also have a free
version called QuickCheck Mini with a reduced feature set. There are
also some open source property testing tools for Erlang such as
<a href="https://github.com/manopapad/proper">PropEr</a>, but I do not have any
first-hand experience using any of them.</p>

<h2>Some Relevant Data</h2>

<p>Here are a couple of tidbits that will help you follow the
story if you are unfamiliar with how <a href="http://www.basho.com">Riak</a>
works.
 * In <a href="http://www.basho.com">Riak</a>, the data that is stored is divided among a set of partitions. Understanding the specifics of a partition is not important here, just understand that a partition is a place where data is stored and that to generate a list of all the object keys for a bucket in <a href="http://www.basho.com">Riak</a> requires accessing a subset of these partitions.
 * The number of partitions is configurable.</p>

<h2>Story Time</h2>

<p>Last week I was working on some changes to how
<a href="http://www.basho.com">Riak</a> manages key listing. I made the changes I
thought were necessary to accomplish my task and did some preliminary
manual testing. This involved inserting a set of objects into a bucket
and then performing a key listing and verifying that results matched
what I expected. This manual testing closely resembles the type of
test cases I would likely create for this code using traditional unit
tests. Pick a few different sizes of object sets and done. Most
developers probably will not spend all day enumerating hundreds of
test cases and the result is that the unit test suite only gives you
assurance that your code works for a very small number of possible
cases. So what about the rest of them? Well, let&rsquo;s continue the story.</p>

<p>It turned out that there was some intermediate results buffering that
I had not accounted for when I made my changes. Each partition would
accumulate the object keys it had stored for a bucket, but once this
buffer contained 100 keys it would send the keys back to the calling
process, empty the buffer, and continue the accumulation. The default
number of partitions in <a href="http://www.basho.com">Riak</a> is 64. The size
of the set of partitions required to list all of the keys from a
bucket when there are 64 partitions is 22 (just take my word for
it). Assuming a uniform distribution of keys among the partitions,
there would need to be at least 2179 objects in a bucket to trigger
the intermediate buffering. The largest set of objects I tried in my
manual testing was 2000, but fortunately the object set size is one of
the inputs that the Quickcheck test for this code generates for me and
when I ran the test it quickly found a case where the expected set of
object keys did not match the actual set of keys returned.</p>

<p>Now chances are good that a suite of traditional unit tests would have
tested an object set greater than 2000, but what if the buffer size
that triggered the intermediate buffering was 1000 or 10000. Or what if
the number of partitions was set to 128 or 256 instead of 64. The
point is that as the number of variables that affect the code
under test increases, the number of test case permutations quickly
becomes difficult to manage with traditional unit test suites and
relies on the developer not to overlook any important
cases.</p>

<p>Instead with Quickcheck the developer describes the characteristics of
the variables that affect the code and Quickcheck explores the
permutations by generating values for the variables and searching for
failing cases.</p>

<h2>In Summary</h2>

<p>Catching and fixing bugs in development saves time and
money. Quickcheck helped me find and eliminate this bug early and I
have a higher level of confidence that my changes are correct.  The
case I described here was rather trivial, but it is illustrative of
the power and usefulness of property-based testing. Creating
Quickcheck tests may take more time than churning out a few unit test
cases (especially as you ascend the learning curve), but this is time
well spent and the investment will pay dividends.</p>

<p>If you would like to have a look at the Quickcheck test I discussed in
this post, you can find it
<a href="https://github.com/basho/riak_kv/blob/master/test/keys_fsm_eqc.erl">here</a>. Happy
testing!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/29/inertia/">Inertia</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-29T00:00:00-06:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2011/06/29/inertia/#disqus_thread"
             data-disqus-identifier="http://kelly-mclaughlin.com/blog/2011/06/29/inertia/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is my third or fourth attempt at starting a blog. My past attempts have failed for a variety of reasons. My excuses range from being too busy or distracted to becoming too focused on tinkering with the blog engine to having all my time and energy consumed by a new baby. I am still very busy and there are a lot of other things vying for my attention, but I think this time will be different. My daughter is over eight months old now so I am getting more sleep and with the help of <a href="http://http://pages.github.com">github pages</a> and <a href="https://github.com/mojombo/jekyll">jekyll</a> I feel like this time I have enough inertia to succeed. I like the convenience of composing posts using <a href="http://daringfireball.net/projects/markdown">markdown</a> and now that I have the setup done and the layout finished, composing new posts should be extremely efficient. I have a backlog of things to write about and there are a lot of exciting things going on at <a href="http://www.basho.com">Basho</a> and with my continuing adventures with software that are bound to generate even more ideas. Until next time.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/02/platform-specific-build-options-with-rebar/">Platform-Specific Build Options With Rebar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/27/emacs-daemon/">Setting Up the Emacs Daemon on OS X</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/21/riak-debug-vm/">Running Riak With a Debug Version of the Erlang VM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/03/erlang-debug-vm/">How to Build a Debug Version of the Erlang VM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/08/quickcheck-efficacy/">A Quickcheck in Time Saves Nine</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/kellymclaughlin">@kellymclaughlin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kellymclaughlin',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Kelly McLaughlin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kellymclaughlin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
