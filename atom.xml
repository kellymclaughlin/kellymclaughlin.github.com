<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[kelly-mclaughlin.com]]></title>
  <link href="http://kelly-mclaughlin.com/atom.xml" rel="self"/>
  <link href="http://kelly-mclaughlin.com/"/>
  <updated>2014-12-12T08:17:50-07:00</updated>
  <id>http://kelly-mclaughlin.com/</id>
  <author>
    <name><![CDATA[Kelly McLaughlin]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building an Erlang Project With Mix]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2014/12/12/building-an-erlang-project-with-mix/"/>
    <updated>2014-12-12T10:58:57-07:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2014/12/12/building-an-erlang-project-with-mix</id>
    <content type="html"><![CDATA[<h3><em>What in the world is Mix? Why would anyone want to do this?</em></h3>

<p>These are the sorts of questions that any readers of this post may be
asking themselves based on the title. The answer to the former is that
<a href="http://elixir-lang.org/getting_started/mix_otp/1.html">Mix</a> is the
build tool of the Elixir ecosystem.  For me the answer to the second
question is simply curiosity and this is a brief summary of my
experience following that curiosity.</p>

<p>As an Erlang developer for the last five years I admit to having paid
very little attention to Elixir until very recently. The inspiration
to actually take a closer look came from listening to an interview
with Jos√© Valim on an
<a href="http://www.functionalgeekery.com/episode-17-jose-valim/">episode</a> of
the <a href="http://www.functionalgeekery.com/">Functional Geekery</a>
podcast. There were several aspects of Elixir discussed that piqued my
interest and one of them was the build tool known as Mix.</p>

<p>Mix provides several features that are appealing having experienced a
lot of frustration with <a href="https://github.com/rebar/rebar">rebar</a>, the
most popular build tool for Erlang projects. Most of the frustration
with rebar comes from the dependency handling and so it was very
interesting to see what Mix offered in this area in particular. Some
of the features I found notable were:</p>

<ul>
<li>Built-in dependency locking behavior to aid in repeatable builds.</li>
<li>Ability to resolve a dependency conflict in the top level
configuration by explicitly <em>overriding</em> any other version of the
same dependency encountered in the dependency tree.</li>
<li>The concept of environments (<em>dev</em>, <em>test</em>, and <em>prod</em> are the defaults)
to facilitate things like omitting test dependencies from the
development or production builds.</li>
<li>An umbrella mode for creating new projects that do not directly
contain source code, but are compositions of other applications and
dependencies.</li>
<li>Ability to specify binary packages from the
<a href="https://hex.pm">Hex package manager</a> as dependencies in addition to
git repositories.</li>
</ul>


<p>In Erlang projects that use rebar some of these things can be
accomplished with plugins or various other workarounds, but I like
that they are baked into Mix. I suspect many of these features will be
part of <a href="https://github.com/rebar/rebar3">rebar3</a>, but it is still in
the development stages whereas Mix can be used today. Another benefit
from using Mix is the possibility for people to contribute to a
project using either Erlang or Elixir. This certainly will not be
applicable to all projects or desired by some, but in general I do
count greater flexibility as a benefit.</p>

<h3>Specifying a Mix configuration</h3>

<p>After hearing the description of Mix on the podcast as mentioned
previously I decided to play around with it a bit. I was very
interested in the fact that Mix could be used to build regular
Erlang projects so I decided to test out what it would take to
actually make this happen for a real project. I have quite a bit of
familiarity with Basho&rsquo;s <a href="https://github.com/basho/riak_cs">riak_cs</a>
project so I decided to use it as my test project.</p>

<p>First here is the <code>rebar.config</code> file from <code>riak_cs</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{sub_dirs, ["rel"]}.
</span><span class='line'>
</span><span class='line'>{require_otp_vsn, "R15|R16"}.
</span><span class='line'>
</span><span class='line'>{cover_enabled, true}.
</span><span class='line'>
</span><span class='line'>%% EDoc options
</span><span class='line'>{edoc_opts, [preprocess]}.
</span><span class='line'>
</span><span class='line'>{lib_dirs, ["deps", "apps"]}.
</span><span class='line'>
</span><span class='line'>{erl_opts, [debug_info, warnings_as_errors, {parse_transform, lager_transform}]}.
</span><span class='line'>
</span><span class='line'>{xref_checks, []}.
</span><span class='line'>{xref_queries,
</span><span class='line'> [{"(XC - UC) || (XU - X - B - \"(^riak$|^riak_cs_dummy_reader$|^riak_core_bucket$|^app_helper$|^riakc_pb_socket_fake$|^riak_object$|^riak_repl_pb_api$|^riak_cs_multibag$)\" : Mod)", []}]}.
</span><span class='line'>{xref_queries_ee,
</span><span class='line'> [{"(XC - UC) || (XU - X - B - \"(^riak$|^riak_cs_dummy_reader$|^riak_core_bucket$|^app_helper$|^riakc_pb_socket_fake$|^riak_object$)\" : Mod)", []}]}.
</span><span class='line'>
</span><span class='line'>{reset_after_eunit, true}.
</span><span class='line'>
</span><span class='line'>{plugin_dir, ".plugins"}.
</span><span class='line'>{plugins, [rebar_test_plugin, rebar_lock_deps_plugin]}.
</span><span class='line'>
</span><span class='line'>{client_test, [
</span><span class='line'>               {test_paths, ["client_tests/erlang"]},
</span><span class='line'>               {test_output, ".client_test"}
</span><span class='line'>              ]}.
</span><span class='line'>{int_test, [
</span><span class='line'>            {test_paths, ["int_test"]},
</span><span class='line'>            {test_output, ".int_test"}
</span><span class='line'>           ]}.
</span><span class='line'>{riak_test, [
</span><span class='line'>             {test_paths, ["riak_test/tests", "riak_test/src",
</span><span class='line'>                           "deps/riak_cs_multibag/riak_test/tests",
</span><span class='line'>                           "deps/riak_cs_multibag/riak_test/src"]},
</span><span class='line'>             {test_output, "riak_test/ebin"}
</span><span class='line'>            ]}.
</span><span class='line'>
</span><span class='line'>{deps, [
</span><span class='line'>        {node_package, "1.3.8", {git, "git://github.com/basho/node_package", {tag, "1.3.8"}}},
</span><span class='line'>        {getopt, ".*", {git, "git://github.com/jcomellas/getopt.git", {tag, "v0.4.3"}}},
</span><span class='line'>        {webmachine, ".*", {git, "git://github.com/basho/webmachine", {tag, "1.10.3"}}},
</span><span class='line'>        {riakc, ".*", {git, "git://github.com/basho/riak-erlang-client", {tag, "1.4.2"}}},
</span><span class='line'>        {lager, ".*", {git, "git://github.com/basho/lager", {tag, "2.0.3"}}},
</span><span class='line'>        {lager_syslog, ".*", {git, "git://github.com/basho/lager_syslog", {tag, "2.0.3"}}},
</span><span class='line'>        {eper, ".*", {git, "git://github.com/basho/eper.git", "0.78"}},
</span><span class='line'>        {druuid, ".*", {git, "git://github.com/kellymclaughlin/druuid.git", {tag, "0.2"}}},
</span><span class='line'>        {velvet, "1.3.*", {git, "git://github.com/basho/velvet", "4bb0fd664ff065c4082ca8dd2e0683e920537d15"}},
</span><span class='line'>        {poolboy, "0.8.*", {git, "git://github.com/basho/poolboy", "0.8.1p2"}},
</span><span class='line'>        {folsom, ".*", {git, "git://github.com/boundary/folsom", {tag, "0.8.1"}}},
</span><span class='line'>        {cluster_info, ".*", {git, "git://github.com/basho/cluster_info", {tag, "1.2.4"}}},
</span><span class='line'>        {xmerl, ".*", {git, "git://github.com/shino/xmerl", "b35bcb05abaf27f183cfc3d85d8bffdde0f59325"}},
</span><span class='line'>        {erlcloud, ".*", {git, "git://github.com/basho/erlcloud.git", {tag, "0.4.4"}}},
</span><span class='line'>        {rebar_lock_deps_plugin, ".*", {git, "git://github.com/seth/rebar_lock_deps_plugin.git", {tag, "3.1.0"}}}
</span><span class='line'>       ]}.
</span><span class='line'>
</span><span class='line'>{deps_ee, [
</span><span class='line'>           {riak_repl_pb_api,".*",{git,"git@github.com:basho/riak_repl_pb_api.git", {tag, "0.2.5"}}},
</span><span class='line'>           {riak_cs_multibag,".*",{git,"git@github.com:basho/riak_cs_multibag.git", {branch, "master"}}}
</span><span class='line'>          ]}.</span></code></pre></td></tr></table></div></figure>


<p>Now here is the mostly equivalent translation to a <code>mix.exs</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>defmodule CS.Mixfile do
</span><span class='line'>  use Mix.Project
</span><span class='line'>
</span><span class='line'>  def project do
</span><span class='line'>    [app: :riak_cs,
</span><span class='line'>     version: "1.5.2",
</span><span class='line'>     compilers: [:erlang, :app],
</span><span class='line'>     erlc_options: [{:parse_transform, :lager_transform}],
</span><span class='line'>     deps: deps]
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def application do
</span><span class='line'>    [applications: [:kernel,
</span><span class='line'>                    :stdlib,
</span><span class='line'>                    :inets,
</span><span class='line'>                    :crypto,
</span><span class='line'>                    :mochiweb,
</span><span class='line'>                    :webmachine,
</span><span class='line'>                    :poolboy,
</span><span class='line'>                    :lager,
</span><span class='line'>                    :cluster_info,
</span><span class='line'>                    :folsom]]
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  defp deps do
</span><span class='line'>    [{:node_package, github: "basho/node_package", tag: "1.3.8", compile: "../../rebar compile"},
</span><span class='line'>     {:getopt, github: "jcomellas/getopt", tag: "v0.4.3"},
</span><span class='line'>     {:ibrowse, github: "cmullaparthi/ibrowse", tag: "v4.0.1", override: true},
</span><span class='line'>     {:webmachine, github: "basho/webmachine", tag: "1.10.6"},
</span><span class='line'>     {:riakc, github: "basho/riak-erlang-client", tag: "1.4.2"},
</span><span class='line'>     {:lager, github: "basho/lager", tag: "2.0.3", override: true},
</span><span class='line'>     {:lager_syslog, github: "basho/lager_syslog", tag: "2.0.3"},
</span><span class='line'>     {:eper, gippthub: "basho/eper", tag: "0.78"},
</span><span class='line'>     {:meck, github: "eproxus/meck", tag: "0.8.2", override: true},
</span><span class='line'>     {:druuid, github: "kellymclaughlin/druuid", tag: "0.3"},
</span><span class='line'>     {:velvet, github: "basho/velvet", ref: "4bb0fd664ff065c4082ca8dd2e0683e920537d15"},
</span><span class='line'>     {:poolboy, github: "devinus/poolboy", tag: "1.4.1"},
</span><span class='line'>     {:folsom, github: "boundary/folsom", tag: "0.8.1"},
</span><span class='line'>     {:cluster_info, github: "basho/cluster_info", tag: "1.2.4"},
</span><span class='line'>     {:erlcloud, github: "basho/erlcloud", tag: "0.4.4", only: :test}
</span><span class='line'>    ]
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>The two files are very similar, but the thing that sticks out most is the
cleaniness of the dependency specification in the Mix file versus the
rebar configuration. The <code>github</code> shorthand is very nice since it is the
most common home for Erlang projects. Also, notice that Mix gathers the
information to generate the project&rsquo;s <code>.app</code> file from information in
the <code>mix.exs</code> file rather than an <code>app.src</code> file.</p>

<p>The dependencies that specify <code>override: true</code> are ones that had
version conflicts and I was able to select the correct version
explicitly at the top level. This is also the reason that the set of
dependencies specified differs slightly between the rebar and Mix
configurations.</p>

<p>In order to build the project I also had to specify a basic <code>mix.exs</code>
file in the apps/riak_cs directory. Here is the listing of that file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Code.require_file "mix.exs", "../.."
</span><span class='line'>
</span><span class='line'>defmodule CS.App.Mixfile do
</span><span class='line'>  use Mix.Project
</span><span class='line'>
</span><span class='line'>  def project do
</span><span class='line'>    []
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>Testing it out</h3>

<p>Elixir and Mix require at least Erlang 17 so I did have to alter the
versions some of the dependencies in order to get a working build due
to some version-related build errors and for some of the Basho
dependencies I had to manually edit the rebar.config file to allow
using version 17 or disable <code>warnings_as_errors</code> (also related to
building with Erlang 17). Beyond that everything built as expected with
very minimal overall effort.</p>

<p>Here are the steps to follow to build the project:</p>

<ol>
<li><code>mix deps.get</code></li>
<li>
Edit <code>deps/velvet/rebar.config</code> in the following manner:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>diff --git a/rebar.config b/rebar.config
</span><span class='line'>index 9a03432..56d7170 100644
</span><span class='line'>--- a/rebar.config
</span><span class='line'>+++ b/rebar.config
</span><span class='line'>@@ -1,10 +1,10 @@
</span><span class='line'>-{require_otp_vsn, "R14B0[234]|R15|R16"}.
</span><span class='line'>+{require_otp_vsn, "R14B0[234]|R15|R16|17"}.
</span><span class='line'>
</span><span class='line'> {cover_enabled, true}.
</span><span class='line'>
</span><span class='line'> {lib_dirs, ["apps"]}.
</span><span class='line'>
</span><span class='line'>-{erl_opts, [debug_info, warnings_as_errors, {parse_transform, lager_transform}]}.
</span><span class='line'>+{erl_opts, [debug_info, {parse_transform, lager_transform}]}.
</span><span class='line'>
</span><span class='line'>{reset_after_eunit, true}.</span></code></pre></td></tr></table></div></figure>
</li>
<li>
Edit <code>deps/riakc/rebar.config</code> in the following manner:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>diff --git a/rebar.config b/rebar.config
</span><span class='line'>index f09a602..9765dc3 100644
</span><span class='line'>--- a/rebar.config
</span><span class='line'>+++ b/rebar.config
</span><span class='line'>@@ -1,6 +1,6 @@
</span><span class='line'> {cover_enabled, true}.
</span><span class='line'> {eunit_opts, [verbose]}.
</span><span class='line'>-{erl_opts, [warnings_as_errors, debug_info]}.
</span><span class='line'>+{erl_opts, [debug_info]}.
</span><span class='line'> {deps, [
</span><span class='line'>         {riak_pb, ".*", {git, "git://github.com/basho/riak_pb", {tag, "1.4.4.0"}}}
</span><span class='line'>        ]}.</span></code></pre></td></tr></table></div></figure>
</li>
 <li><code>mix deps.compile && mix compile</code></li>
</ol>


<p>That is all there is to it. The results should be in the local <code>_build</code>
directory.</p>

<h3>Conclusion and further explorations</h3>

<p>Mix appears to be a well-implemented, flexible build tool for building
Elixir or Erlang projects. From an Erlang developer&rsquo;s perspective, it
definitely addresses some pain points that frequently arise with
dependency handling with rebar.</p>

<p>I also like that the build tool is a core part of the Elixir
ecosystem. Many Erlang projects include a copy of the rebar executable
as part of the git repository because rebar is not the official Erlang
build tool and is not distributed as part of the language
installation. This, in my view, is a problematic and sloppy solution so
Elixir definitely improves upon that with Mix.</p>

<p>I have not explored how Elixir/Mix handle interaction with
<a href="http://www.erlang.org/doc/man/reltool.html">reltool</a> for creating
releases yet. An interesting next step will be to explore this more
and attempt to get an actual release of the project created. One missing
thing from the <code>rebar.config</code> in the example of <code>riak_cs</code> is the
handling of the rebar plugin for executing customized testing
functions. Translating the plugin actions into Mix tasks would be
another interesting learning experience.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Platform-Specific Build Options With Rebar]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2014/12/02/platform-specific-build-options-with-rebar/"/>
    <updated>2014-12-02T10:48:46-07:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2014/12/02/platform-specific-build-options-with-rebar</id>
    <content type="html"><![CDATA[<p>Several months back someone reported an
<a href="https://github.com/kellymclaughlin/druuid/issues/3">issue</a> when
attempting to use
<a href="https://github.com/kellymclaughlin/druuid"><code>druuid</code></a> as a dependency
in an Elixir project.  At the time I was not able to look into it, but
recently I circled back to dig deeper into the problem (described in
more detail <a href="https://github.com/elixir-lang/elixir/issues/2189">here</a>)
and in the process I stumbled across some useful rebar configuration
options for projects that have platform-specific build requirements. I
use rebar quite a bit, but I was not aware that these options
existed so I wrote this in case other rebar users find themselves in a
similar state of ignorance.</p>

<p><code>Druuid</code> needs to differentiate between BSD and non-BSD systems during
the <code>compile</code> and <code>clean</code> operations. This is due to a conflict with
the OS-provided UUID library on BSD systems.  The original method used
to achieve this was rebar&rsquo;s dynamic configuration capability. A
rebar.config.script file was used to check the system architecture
information using <code>rebar_utils:is_arch/1</code> and modify the rebar
configuration appropriately based on the results (<a href="https://github.com/kellymclaughlin/druuid/pull/2">relevant github issue</a>). <a href="https://github.com/kellymclaughlin/druuid/blob/0.2/rebar.config.script">Here</a>
is the full listing of the <code>rebar.config.script</code> file for reference.</p>

<p>This solution certainly works, but it would be great if there was a
way to use standard rebar configuration options to solve the problem
and even better if anyone who wants to use the library, be it in
an Erlang project or an Elixir project, could easily do so.</p>

<p>Fortunately such configuration capabilities already exist in
rebar. <code>Druuid</code> uses four rebar configuration directives to tailor the
build environment and steps based on the platform.  These are as
follows: <code>port_specs</code>, <code>port_env</code>, <code>pre_hooks</code>, <code>post_hooks</code>. Each
option is specified in the <code>rebar.config</code> file as a pair where the
first element is the option name and the second element is a list of
tuples.</p>

<p>For example, here is what a <code>port_env</code> entry might look like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{port_env, [{"CFLAGS", "$CFLAGS -fPIC"},
</span><span class='line'>            {"DRV_CFLAGS", "$DRV_CFLAGS -Werror -I c_src/uuid-1.6.2"},
</span><span class='line'>            {"DRV_LDFLAGS", "$DRV_LDFLAGS c_src/uuid-1.6.2/.libs/libuuid.a"}
</span><span class='line'>]}.</span></code></pre></td></tr></table></div></figure>


<p>It turns out that the value tuples can be a pair as shown in the above
example <strong>or</strong> they can be triples where the first element is a
regular expression that is applied as a filter to the platform
information. Let&rsquo;s see an example of that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{port_env, [{"CFLAGS", "$CFLAGS -fPIC"},
</span><span class='line'>            {"(bsd)", "DRV_CFLAGS", "$DRV_CFLAGS -Werror"},
</span><span class='line'>            {"(bsd)", "DRV_LDFLAGS", "$DRV_LDFLAGS"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_CFLAGS", "$DRV_CFLAGS -Werror -I c_src/uuid-1.6.2"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_LDFLAGS", "$DRV_LDFLAGS c_src/uuid-1.6.2/.libs/libuuid.a"}
</span><span class='line'>]}.</span></code></pre></td></tr></table></div></figure>


<p>The <code>CFLAGS</code> value is applied to all platforms, but <code>DRV_CFLAGS</code> and
<code>DRV_LDFLAGS</code> are selected based on whether the platform information
does or does not contain the string <em>bsd</em>. This is very handy and can
also be used for all of the other configuration options used by
<code>druuid</code>. Let&rsquo;s see the final version of the <code>rebar.config</code> file that
translates all of the behavior previously contained in the
<code>rebar.config.script</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{port_specs, [{"priv/druuid.so", ["c_src/*.c"]}]}.
</span><span class='line'>{port_env, [{"CFLAGS", "$CFLAGS -fPIC"},
</span><span class='line'>            {"(bsd)", "DRV_CFLAGS", "$DRV_CFLAGS -Werror"},
</span><span class='line'>            {"(bsd)", "DRV_LDFLAGS", "$DRV_LDFLAGS"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_CFLAGS", "$DRV_CFLAGS -Werror -I c_src/uuid-1.6.2"},
</span><span class='line'>            {"^(?s)((?!bsd).)*$", "DRV_LDFLAGS", "$DRV_LDFLAGS c_src/uuid-1.6.2/.libs/libuuid.a"}
</span><span class='line'>]}.
</span><span class='line'>{pre_hooks, [{"^(?s)((?!bsd).)*$", compile, "c_src/build_deps.sh"}]}.
</span><span class='line'>{post_hooks, [{"^(?s)((?!bsd).)*$", clean, "c_src/build_deps.sh clean"}]}.</span></code></pre></td></tr></table></div></figure>


<p>This is much nicer than resorting to using rebar&rsquo;s dynamic
configuration and as a bonus it works much better with Elixir&rsquo;s build
tool, <a href="http://elixir-lang.org/getting_started/mix_otp/1.html">Mix</a>. If
you want to explore how the regular expressions are treated inside
rebar, look
<a href="https://github.com/rebar/rebar/blob/2.5.1/src/rebar_core.erl#L507">here</a>
for the hooks,
<a href="https://github.com/rebar/rebar/blob/2.5.1/src/rebar_port_compiler.erl#L308">here</a>
for the <code>port_specs</code>, and
<a href="https://github.com/rebar/rebar/blob/2.5.1/src/rebar_port_compiler.erl#L484">here</a>
for the <code>port_env</code> for the port options.</p>

<p>I did not find any mention of these options in the rebar wiki. I did
find some examples of the port options in the output of <code>rebar help
compile</code>, but hopefully this post sheds some further light on their
intended purpose. Also note that the information in this post is based
on the <code>2.5.1</code> tag of rebar. Later tags or the work on
<a href="https://github.com/rebar/rebar3">rebar3</a> may make some of this
information obsolete.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setting Up the Emacs Daemon on OS X]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2012/07/27/emacs-daemon/"/>
    <updated>2012-07-27T00:00:00-06:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2012/07/27/emacs-daemon</id>
    <content type="html"><![CDATA[<p><em>Warning:</em> I only use terminal emacs so I have no idea how well this will work otherwise.</p>

<h2>Install emacs 23 or later.</h2>

<p>Here is what I use to get the very latest emacs goodies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo brew install emacs --cocoa --use-git-head --HEAD</span></code></pre></td></tr></table></div></figure>


<p>Some people have had trouble with the <code>--cocoa</code> flag so you may find
it convenient to omit that if you do not need the Cocoa version. Also
if you do not want the bleeding edge version, then omit the
<code>--use-git-head --HEAD</code> options.</p>

<h2>Create a plist file and move it to ~/Library/LaunchAgents</h2>

<p>Here is what my file looks like:</p>

<div>
  <pre><code class='xml'>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
  &lt;plist version=&quot;1.0&quot;&gt;
    &lt;dict&gt;
      &lt;key&gt;Label&lt;/key&gt;
      &lt;string&gt;gnu.emacs.daemon&lt;/string&gt;
      &lt;key&gt;ProgramArguments&lt;/key&gt;
      &lt;array&gt;
        &lt;string&gt;/usr/local/Cellar/emacs/HEAD/Emacs.app/Contents/MacOS/Emacs&lt;/string&gt;
        &lt;string&gt;--daemon&lt;/string&gt;
      &lt;/array&gt;
      &lt;key&gt;RunAtLoad&lt;/key&gt;
      &lt;true/&gt;
      &lt;key&gt;ServiceDescription&lt;/key&gt;
      &lt;string&gt;Gnu Emacs Daemon&lt;/string&gt;
      &lt;key&gt;UserName&lt;/key&gt;
      &lt;string&gt;kelly&lt;/string&gt;
    &lt;/dict&gt;
  &lt;/plist&gt;</code></pre>
</div>


<p>Update the path the emacs and change the username to your OS X user name.</p>

<h2>Start the daemon</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>launchctl load gnu.emacs.daemon
</span><span class='line'>launchctl start gnu.emacs.daemon</span></code></pre></td></tr></table></div></figure>


<h3>Edit files with emacsclient instead of emacs</h3>

<p>Instead of opening a file with <code>emacs &lt;filename&gt;</code> instead use <code>emacsclient -nw &lt;filename&gt;</code>.</p>

<p>I created a handy alias in my <code>.bashrc</code> file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>alias e="emacsclient -nw"</span></code></pre></td></tr></table></div></figure>


<h3>Stopping the daemon</h3>

<p>From within emacs, use the <code>save-buffers-kill-emacs</code> command.</p>

<p>Outside of emacs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>emacsclient -e '(save-buffers-kill-emacs)'</span></code></pre></td></tr></table></div></figure>


<h3>Why bother?</h3>

<p>Setting up the daemon has a several advantages.</p>

<ol>
<li>Files load much faster.</li>
<li>You can share buffers among different <code>emacsclient</code> instances.</li>
<li>If you exit all the <code>emacsclient</code> instances and come back later,
your buffers are all still open. When you access a buffer the cursor
will be at the exact spot you left off previously.</li>
</ol>


<h3>Downsides</h3>

<p>The server does occasionally crash, but that is probably because I am
using the bleeding edge version. It hasn&rsquo;t caused me to lose anything
thanks to auto-saving and file recovery so go for it.</p>

<h3>References</h3>

<ul>
<li><a href="http://www.emacswiki.org/emacs/EmacsAsDaemon">EmacsWiki</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Running Riak With a Debug Version of the Erlang VM]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2012/01/21/riak-debug-vm/"/>
    <updated>2012-01-21T00:00:00-07:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2012/01/21/riak-debug-vm</id>
    <content type="html"><![CDATA[<p>In this post I describe how the easiest way to run
<a href="http://www.basho.com">Riak</a> with a debug build of the Erlang
VM. While I focus specifically on Riak, this procedure should hold
true for most Erlang projects that are set up for release builds using
rebar.</p>

<p>First, make sure the debug build of Erlang is the first in your
path. If you have not built a debug-enabled Erlang VM, I covered how
to accomplish that in a prior post and you can find it
<a href="http://kelly-mclaughlin.com/2012/01/03/erlang-debug-vm.html">here</a>.</p>

<p>Next navigate to your Riak repository and do a clean and release build
of Riak.</p>

<div>
  <pre><code class='bash'>make clean rel</code></pre>
</div>


<p>Move to the Riak release directory and open the riak script in an editor.</p>

<div>
  <pre><code class='bash'>cd rel/riak
emacs bin/riak</code></pre>
</div>


<p>Look for the line <code>EMU=beam</code>. It should be located somewhere around
line 228 in the section for the <code>console</code> command. Change that line to
<code>EMU=beam.debug</code> and save the file.</p>

<p>Now you are ready to start up Riak. For this example I just start it
with <em>console</em> instead of <em>start</em>.</p>

<div>
  <pre><code class='bash'>./bin/riak console</code></pre>
</div>


<p>You should notice the Erlang banner is slightly different than
normal. Using the normal Erlang VM the banner looks something like
this:</p>

<div>
  <pre><code class='erlang'>Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:64] [kernel-poll:true]</code></pre>
</div>


<p>However using the debug-enabled VM, it should look something like the
following:</p>

<div>
  <pre><code class='erlang'>Erlang R15B (erts-5.9) [source] [64-bit] [smp:4:4] [async-threads:64] [kernel-poll:true] [type-assertions] [debug-compiled] [lock-checking]</code></pre>
</div>


<p>And that&rsquo;s all there is to it. Once you have the debug-enabled Erlang
VM built, it&rsquo;s very easy to get Riak up and running with it. It may go
without saying, but Riak will run noticeably slower using the
debug-enabled VM so please do not run in this manner in
production. Happy debugging!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Build a Debug Version of the Erlang VM]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2012/01/03/erlang-debug-vm/"/>
    <updated>2012-01-03T00:00:00-07:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2012/01/03/erlang-debug-vm</id>
    <content type="html"><![CDATA[<p>Last week I needed a debug build of BEAM (the Erlang VM). I decided to
write this blog post detailing how to go about building it because I
found the process to be cumbersome and the documentation detailing how
to do it rather sparse. There is a section in the
<a href="http://www.erlang.org/doc/installation_guide/INSTALL.html#id70822">Erlang documentation</a>
that discusses how to build a debug-enabled Erlang runtime, but I
found the procedures I will discuss in this post to be more
straightforward. Hopefully my experience can help others who may
venture down this path, but if nothing else it will serve as a useful
reminder for myself the next time I need to do it.</p>

<p>Before starting I should note that all of the following steps have
been performed on my MBP running OSX Lion and using Erlang R15B.</p>

<p>To start things off you&rsquo;ll need to have the Erlang source. Grab the latest
version from <a href="http://www.erlang.org/download.html">here</a> if you do not
already have it. You may want to move the source tarball into an
<em>erlang</em> sub-directory somewhere to keep everything organized.</p>

<p>Next let&rsquo;s build normally. We will specify the installation
destination as a local debug-labeled directory using the <code>--prefix</code>
option to the Erlang/OTP <code>configure</code> script, but we will not install until after
taking some extra steps to build debug versions of BEAM. One important
thing to note is that I have disabled <code>HiPE</code> because I found it to
cause build failures when building the debug versions.</p>

<p>The following is a bash script that can be run to accomplish this
first step. To run it, save the script to the local directory where
you have the erlang source tarball, make it executable, and run
it. The script expects an argument that specifies the version of
Erlang to build. <em>e.g.</em> If you saved the script as <code>build_erlang.sh</code>,
you would run the following: <code>build_erlang.sh R15B</code>.</p>

<div>
  <pre><code class='bash'>#! /bin/bash

OTPVERUC:=$(echo $1 || if=- conv=ucase)
OTPVERLC:=$(echo $1 || if=- conv=lcase)
TARBALL=otp_src_$OTPVERUC.tar.gz
LOCAL_DIR=`pwd`

## Build 64-bit OSX
build_64()
{
tar xfz $TARBALL
mv otp_src_$OTPVERUC{,-64}
( cd otp_src_$OTPVERUC-64 \
    &amp;&amp; ./configure --enable-debug --enable-threads --enable-kernel-poll \
    --enable-smp-support --enable-darwin-64bit --enable-lock-checking=no --disable-hipe \
    --prefix=/Users/kelly/erlang/$OTPVERLC-debug-64 \
    &amp;&amp; make )
}

## Build 64-bit version
build_64</code></pre>
</div>


<p>Once the normal build has successfully completed, it&rsquo;s time to do the
debug build. <code>cd</code> to the unpacked erlang source directory
(<em>otp_src_R15B-64</em> if using the script from above). The next step is
to export a three environment variables in your shell. The first is
<code>ERL_TOP</code> which serves as a reference for many of the build files and
scripts. Next is the <code>FLAVOR</code> and the options are either <code>plain</code> or
<code>smp</code>. Finally <code>TYPE</code> should be set to <code>debug</code>.</p>

<pre>
<code>
export ERL_TOP=`pwd`
export FLAVOR=smp
export TYPE=debug
</code>
</pre>


<p>Now type <code>make</code> and hit enter and wait. Once the build is complete,
there should be a <code>beam.debug.smp</code> file in addition to the normal
<code>beam.smp</code> (assuming you set the FLAVOR as smp). To build the other
flavor, just change the value of <code>FLAVOR</code> and run make again.</p>

<p>The final step is to install everything. Do this by typing <code>make
install</code> and once it completes Erlang/OTP will be installed in
<em>R15B-debug-64</em> including debug-enabled builds of BEAM.</p>

<p>Of course a simplified approach would just be to script all of these
steps, so here is the previous build script augmented to also build
both flavors of the debug vm and then install everything.</p>

<div>
  <pre><code class='bash'>#! /bin/bash

OTPVERUC:=$(echo $1 || if=- conv=ucase)
OTPVERLC:=$(echo $1 || if=- conv=lcase)
TARBALL=otp_src_$OTPVERUC.tar.gz
LOCAL_DIR=`pwd`

## Build 64-bit OSX
build_64()
{
tar xfz $TARBALL
mv otp_src_$OTPVERUC{,-64}
( cd otp_src_$OTPVERUC-64 \
    &amp;&amp; ./configure --enable-debug --enable-threads --enable-kernel-poll \
    --enable-smp-support --enable-darwin-64bit --disable-hipe \
    --prefix=$LOCAL_DIR/$OTPVERLC-debug-64 \
    &amp;&amp; make \
    &amp;&amp; make install \
    &amp;&amp; export TYPE=debug; export FLAVOR=plain; make \
    &amp;&amp; FLAVOR=smp; make \
    &amp;&amp; make install )
}

## Build 64-bit version
build_64</code></pre>
</div>


<p>That&rsquo;s all there is to it. In the next post I will cover how configure
<a href="http://www.basho.com">Riak</a> to run using the debug-enabled version of
Erlang. Until then, happy coding.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Quickcheck in Time Saves Nine]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2011/07/08/quickcheck-efficacy/"/>
    <updated>2011-07-08T00:00:00-06:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2011/07/08/quickcheck-efficacy</id>
    <content type="html"><![CDATA[<p>Today I am going to present some anecdotal evidence on the efficacy
of property-based testing. The specific tool in this case is Quiviq&rsquo;s
<a href="http://www.quviq.com/">Quickcheck</a>, a property-based testing tool for
Erlang. I am not going to spend <em>much</em> time discussing the particulars
of property-based testing, but instead focus on a specific real-world
instance where it saved me and my employer,
<a href="http://www.basho.com/">Basho</a>, time and money.</p>

<h2>The Bare Essentials</h2>

<p>Very briefly, here is enough about how property-based testing with
Quickcheck works to whet your appetite. When doing property-based
testing you specify a set of properties of the code you are testing,
create a model, and then test if the model holds for all (or a large
number) of permutations of those properties.</p>

<p>My coworker Rusty Klophaus published a very good 3-minute podcast on
property-based testing
<a href="http://riak.minutewith.com/pages/20110128">here</a> that you <em>should</em>
listen to now if you have not already.</p>

<p>The full version of Quickcheck requires a license which I am fortunate
enough to be able to use when testing code for
<a href="http://www.basho.com/">Basho</a>. <a href="http://www.quviq.com/contact.html">Contact</a>
Quiviq for more information about that or they also have a free
version called QuickCheck Mini with a reduced feature set. There are
also some open source property testing tools for Erlang such as
<a href="https://github.com/manopapad/proper">PropEr</a>, but I do not have any
first-hand experience using any of them.</p>

<h2>Some Relevant Data</h2>

<p>Here are a couple of tidbits that will help you follow the
story if you are unfamiliar with how <a href="http://www.basho.com">Riak</a>
works.
 * In <a href="http://www.basho.com">Riak</a>, the data that is stored is divided among a set of partitions. Understanding the specifics of a partition is not important here, just understand that a partition is a place where data is stored and that to generate a list of all the object keys for a bucket in <a href="http://www.basho.com">Riak</a> requires accessing a subset of these partitions.
 * The number of partitions is configurable.</p>

<h2>Story Time</h2>

<p>Last week I was working on some changes to how
<a href="http://www.basho.com">Riak</a> manages key listing. I made the changes I
thought were necessary to accomplish my task and did some preliminary
manual testing. This involved inserting a set of objects into a bucket
and then performing a key listing and verifying that results matched
what I expected. This manual testing closely resembles the type of
test cases I would likely create for this code using traditional unit
tests. Pick a few different sizes of object sets and done. Most
developers probably will not spend all day enumerating hundreds of
test cases and the result is that the unit test suite only gives you
assurance that your code works for a very small number of possible
cases. So what about the rest of them? Well, let&rsquo;s continue the story.</p>

<p>It turned out that there was some intermediate results buffering that
I had not accounted for when I made my changes. Each partition would
accumulate the object keys it had stored for a bucket, but once this
buffer contained 100 keys it would send the keys back to the calling
process, empty the buffer, and continue the accumulation. The default
number of partitions in <a href="http://www.basho.com">Riak</a> is 64. The size
of the set of partitions required to list all of the keys from a
bucket when there are 64 partitions is 22 (just take my word for
it). Assuming a uniform distribution of keys among the partitions,
there would need to be at least 2179 objects in a bucket to trigger
the intermediate buffering. The largest set of objects I tried in my
manual testing was 2000, but fortunately the object set size is one of
the inputs that the Quickcheck test for this code generates for me and
when I ran the test it quickly found a case where the expected set of
object keys did not match the actual set of keys returned.</p>

<p>Now chances are good that a suite of traditional unit tests would have
tested an object set greater than 2000, but what if the buffer size
that triggered the intermediate buffering was 1000 or 10000. Or what if
the number of partitions was set to 128 or 256 instead of 64. The
point is that as the number of variables that affect the code
under test increases, the number of test case permutations quickly
becomes difficult to manage with traditional unit test suites and
relies on the developer not to overlook any important
cases.</p>

<p>Instead with Quickcheck the developer describes the characteristics of
the variables that affect the code and Quickcheck explores the
permutations by generating values for the variables and searching for
failing cases.</p>

<h2>In Summary</h2>

<p>Catching and fixing bugs in development saves time and
money. Quickcheck helped me find and eliminate this bug early and I
have a higher level of confidence that my changes are correct.  The
case I described here was rather trivial, but it is illustrative of
the power and usefulness of property-based testing. Creating
Quickcheck tests may take more time than churning out a few unit test
cases (especially as you ascend the learning curve), but this is time
well spent and the investment will pay dividends.</p>

<p>If you would like to have a look at the Quickcheck test I discussed in
this post, you can find it
<a href="https://github.com/basho/riak_kv/blob/master/test/keys_fsm_eqc.erl">here</a>. Happy
testing!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Inertia]]></title>
    <link href="http://kelly-mclaughlin.com/blog/2011/06/29/inertia/"/>
    <updated>2011-06-29T00:00:00-06:00</updated>
    <id>http://kelly-mclaughlin.com/blog/2011/06/29/inertia</id>
    <content type="html"><![CDATA[<p>This is my third or fourth attempt at starting a blog. My past attempts have failed for a variety of reasons. My excuses range from being too busy or distracted to becoming too focused on tinkering with the blog engine to having all my time and energy consumed by a new baby. I am still very busy and there are a lot of other things vying for my attention, but I think this time will be different. My daughter is over eight months old now so I am getting more sleep and with the help of <a href="http://http://pages.github.com">github pages</a> and <a href="https://github.com/mojombo/jekyll">jekyll</a> I feel like this time I have enough inertia to succeed. I like the convenience of composing posts using <a href="http://daringfireball.net/projects/markdown">markdown</a> and now that I have the setup done and the layout finished, composing new posts should be extremely efficient. I have a backlog of things to write about and there are a lot of exciting things going on at <a href="http://www.basho.com">Basho</a> and with my continuing adventures with software that are bound to generate even more ideas. Until next time.</p>
]]></content>
  </entry>
  
</feed>
